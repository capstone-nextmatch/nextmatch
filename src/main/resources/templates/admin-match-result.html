<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ê²½ê¸° ê²°ê³¼ ì…ë ¥</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 0; background: #f4f4f9; }
        .admin-header { background: #333; color: white; padding: 15px 30px; }
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        h1 { color: #333; }

        /* --- ëŒ€ì§„í‘œ ìŠ¤íƒ€ì¼ (ë‹¨ìˆœí™”) --- */
        .bracket-container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .match-round { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        .match-item { background: #e0f7fa; padding: 10px; border-radius: 6px; cursor: pointer; border-left: 5px solid #00bcd4; transition: background 0.2s; }
        .match-item:hover { background: #b2ebf2; }
        .match-item.finished { background: #c8e6c9; border-left-color: #4caf50; cursor: default; }

        /* --- ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ê²°ê³¼ ì…ë ¥ íŒì—…) --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 30px; border: 1px solid #888; width: 350px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: #000; text-decoration: none; cursor: pointer; }
        .modal-content input { width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        .modal-content button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px; }
        .score-input-group { display: flex; gap: 10px; align-items: center; }
        .score-input-group label { flex: 1; text-align: right; }
        .score-input-group input { flex: 2; }
    </style>
</head>
<body>
<header class="admin-header">
    <strong>ê²½ê¸° ê²°ê³¼ ì…ë ¥</strong>
</header>

<div class="container">
    <h1 id="contest-title">ëŒ€ì§„í‘œ ë° ê²½ê¸° ê²°ê³¼ (ëŒ€íšŒ ID: Loading...)</h1>

    <div class="bracket-container">
        <h2>ì§„í–‰ ì¤‘/ì˜ˆì • ë§¤ì¹˜</h2>
        <div id="match-list" class="match-round">
            <p id="match-loading-status">ê²½ê¸° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>
</div>

<div id="result-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>ê²½ê¸° ê²°ê³¼ ì…ë ¥</h2>
        <p id="current-match-info">ë¼ìš´ë“œ: 16ê°• Aì¡°</p>

        <form id="result-form">
            <input type="hidden" id="match-id-input">

            <div class="score-input-group">
                <label id="team-a-label">Team A ì ìˆ˜:</label>
                <input type="number" id="score-a-input" required min="0">
            </div>

            <div class="score-input-group">
                <label id="team-b-label">Team B ì ìˆ˜:</label>
                <input type="number" id="score-b-input" required min="0">
            </div>

            <button type="submit">ê²°ê³¼ ì €ì¥ ë° ëŒ€ì§„í‘œ ë°˜ì˜</button>
            <p id="api-message" style="color: red; margin-top: 10px; text-align: center;"></p>
        </form>
    </div>
</div>

<script>
    const contestId = new URLSearchParams(window.location.search).get('contestId');
    const modal = document.getElementById('result-modal');
    const closeBtn = document.querySelector('.close-btn');
    const form = document.getElementById('result-form');

    document.addEventListener('DOMContentLoaded', () => {
        if (contestId) {
            document.getElementById('contest-title').textContent = `ê²½ê¸° ê²°ê³¼ ì…ë ¥ (ëŒ€íšŒ ID: ${contestId})`;
            // ì‹¤ì œ êµ¬í˜„ ì‹œ, contestIdë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ëŒ€íšŒì˜ match ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” APIë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
            fetchMatches(contestId);
        } else {
            alert('ëŒ€íšŒ IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ëª©ë¡ í˜ì´ì§€ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
            window.location.href = '/admin/match/list';
        }
    });

    // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
    closeBtn.onclick = () => { modal.style.display = 'none'; }
    window.onclick = (event) => { if (event.target === modal) modal.style.display = 'none'; }


    // ğŸ›‘ (ì„ì‹œ) ê²½ê¸° ëª©ë¡ ë¡œë“œ í•¨ìˆ˜ (ì‹¤ì œë¡œëŠ” MatchRepositoryë¥¼ ì‚¬ìš©í•˜ëŠ” API í•„ìš”)
    function fetchMatches(cId) {
        // ì´ APIëŠ” AdminMatchControllerì— ì¶”ê°€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        // ì˜ˆ: @GetMapping("/matches") public List<MatchDto> getMatches(@RequestParam Long contestId)

        // í˜„ì¬ëŠ” ë”ë¯¸ ë°ì´í„°ë¡œ ëŒ€ì²´í•˜ì—¬ ëª¨ë‹¬ í´ë¦­ ê¸°ëŠ¥ë§Œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
        const dummyMatches = [
            { id: 1, round: "16ê°• Aì¡°", teamA: "ê³¤ìê°€", teamB: "ì¡°ì§€ì•„ ì£¼ë¦½", status: "UPCOMING" },
            { id: 2, round: "16ê°• Bì¡°", teamA: "ë³´ì´ì‹œ ì£¼ë¦½", teamB: "ë©¤í”¼ìŠ¤", status: "UPCOMING" },
            { id: 3, round: "ê²°ìŠ¹ì „", teamA: "Team C (ë¶ˆì‚¬ì¡°)", teamB: "Team D (ë…ìˆ˜ë¦¬)", status: "FINISHED" }
        ];

        const container = document.getElementById('match-list');
        container.innerHTML = ''; // ì´ˆê¸°í™”

        dummyMatches.forEach(match => {
            const item = createMatchItem(match);
            container.appendChild(item);
        });
        document.getElementById('match-loading-status').style.display = 'none';
    }


    // ğŸ›‘ ë§¤ì¹˜ ì•„ì´í…œ ìƒì„± ë° í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ëª¨ë‹¬ ë„ìš°ê¸°)
    function createMatchItem(match) {
        const item = document.createElement('div');
        item.className = 'match-item' + (match.status === 'FINISHED' ? ' finished' : '');

        item.innerHTML = `
            <div><strong>${match.round}</strong></div>
            <div>${match.teamA || '(ë¯¸ì •)'} vs ${match.teamB || '(ë¯¸ì •)'}</div>
            ${match.status === 'FINISHED' ? '<div>ê²°ê³¼: ' + (match.scoreA || 0) + ' - ' + (match.scoreB || 0) + ' (ì™„ë£Œ)</div>' : '<div>í´ë¦­í•˜ì—¬ ê²°ê³¼ ì…ë ¥</div>'}
        `;

        if (match.status !== 'FINISHED') {
            item.addEventListener('click', () => {
                document.getElementById('match-id-input').value = match.id;
                document.getElementById('current-match-info').textContent = `ë¼ìš´ë“œ: ${match.round} (${match.teamA} vs ${match.teamB})`;
                document.getElementById('team-a-label').textContent = `${match.teamA} ì ìˆ˜:`;
                document.getElementById('team-b-label').textContent = `${match.teamB} ì ìˆ˜:`;
                document.getElementById('api-message').textContent = '';
                // ì ìˆ˜ ì´ˆê¸°í™”
                document.getElementById('score-a-input').value = '';
                document.getElementById('score-b-input').value = '';
                modal.style.display = 'block';
            });
        }
        return item;
    }


    // ğŸ›‘ í¼ ì œì¶œ ì´ë²¤íŠ¸ (API í˜¸ì¶œ)
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const matchId = document.getElementById('match-id-input').value;
        const scoreA = parseInt(document.getElementById('score-a-input').value);
        const scoreB = parseInt(document.getElementById('score-b-input').value);
        const messageEl = document.getElementById('api-message');

        const payload = {
            scoreA: scoreA,
            scoreB: scoreB
        };

        messageEl.style.color = 'gray';
        messageEl.textContent = 'ì €ì¥ ì¤‘...';

        fetch(`/admin/match/${matchId}/result`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('ì„œë²„ ì˜¤ë¥˜: ê²°ê³¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            return response.text();
        })
        .then(result => {
            messageEl.style.color = 'green';
            messageEl.textContent = `ê²°ê³¼ ì €ì¥ ì„±ê³µ (${result}). ëŒ€ì§„í‘œì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            // ëª¨ë‹¬ ë‹«ê¸°
            setTimeout(() => {
                modal.style.display = 'none';
                // ğŸ›‘ ì €ì¥ í›„ ëŒ€ì§„í‘œë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë°˜ì˜ëœ ê²°ê³¼ë¥¼ ë³´ì—¬ì¤˜ì•¼ í•©ë‹ˆë‹¤.
                // fetchMatches(contestId);
                window.location.reload();
            }, 1500);
        })
        .catch(error => {
            messageEl.style.color = 'red';
            messageEl.textContent = error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            console.error("API Error:", error);
        });
    });

</script>
</body>
</html>