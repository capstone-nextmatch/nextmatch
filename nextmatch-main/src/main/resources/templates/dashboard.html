<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NextMatch - 대회 목록</title>
    <style>
        body { font-family: system-ui, apple-system, Segoe UI, Roboto; margin: 0 }
        header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #eee }
        nav a { margin-right: 12px; text-decoration: none; color: #333 }
        .container { max-width: 960px; margin: 24px auto; padding: 0 16px }

        /* 기존 UI 스타일은 유지 */
        .card { border: 1px solid #eee; border-radius: 12px; padding: 20px }
        .btn { display: inline-block; padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; text-decoration: none; color: #111 }
        .btn.primary { background: #111; color: #fff; border-color: #111 }

        /* 목록을 위한 추가 스타일 */
        .competition-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* 반응형 3개 컬럼 */
            gap: 20px;
            margin-top: 20px;
        }
        .event-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .event-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .event-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        .event-card .card-body {
            padding: 15px;
        }
        .event-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .event-card p {
            margin: 0 0 5px 0;
            font-size: 0.9em;
            color: #555;
        }
        .event-card .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 10px;
        }
        .status-upcoming { background: #e0f7fa; color: #00bcd4; }
        .status-ongoing { background: #fffde7; color: #ffeb3b; }
        .status-finished { background: #fbecec; color: #f44336; }

        /* <a> 태그의 밑줄 제거 */
        .event-card a {
            text-decoration: none;
            color: inherit;
            display: block;
        }
    </style>
</head>
<body>
<header>
    <strong>NextMatch</strong>
    <nav>
        <a href="/dashboard">메인</a>
        <a href="/signin">로그인</a>
        <a href="/signup">회원가입</a>
    </nav>
</header>

<div class="container">

    <form id="search-form" style="margin-bottom: 20px; display: flex; gap: 8px;">
        <input type="text" id="search-input" placeholder="대회 이름 검색" style="flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
        <button type="submit" class="btn primary">검색</button>
    </form>

    <h1>전체 대회 목록</h1>

    <div id="competition-list-container" class="competition-list-container">

        <div id="no-results" style="display: none; width: 100%; text-align: center; padding: 50px; color: #777; grid-column: 1 / -1;">
            <p>검색 결과가 없거나 데이터를 불러오는 중 오류가 발생했습니다.</p>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        fetchEvents();

        const searchForm = document.getElementById('search-form');
        if (searchForm) {
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const searchTerm = document.getElementById('search-input').value;
                fetchEvents(searchTerm);
            });
        }
    });

    /**
     * 서버에서 대회 목록을 가져와 화면에 렌더링합니다.
     */
    function fetchEvents(searchTerm = '') {
        const container = document.getElementById('competition-list-container');
        const noResults = document.getElementById('no-results');

        if (!container) {
            console.error("오류: 'competition-list-container' ID를 가진 요소를 찾을 수 없습니다.");
            return;
        }

        const url = `/api/event/list?search=${encodeURIComponent(searchTerm)}`;

        // 기존 목록 초기화
        container.innerHTML = '';
        if (noResults) noResults.style.display = 'none';

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(events => {
                console.log("데이터 수신 성공. 이벤트 개수:", events.length);

                if (events.length === 0) {
                    if (noResults) noResults.style.display = 'block';
                    noResults.innerHTML = `<p>검색 결과가 없습니다.</p>`;
                } else {
                    events.forEach(event => {
                        console.log("Rendering event:", event.title, event.id);
                        const card = createEventCard(event);
                        container.appendChild(card);
                    });
                }
            })
            .catch(error => {
                console.error("Error fetching events:", error);
                if (noResults) {
                     noResults.innerHTML = `<p>데이터를 불러오지 못했습니다. 서버 상태를 확인하세요. (Console 확인)</p>`;
                     noResults.style.display = 'block';
                }
            });
    }

    /**
     * 개별 이벤트 데이터를 기반으로 HTML 카드 요소를 생성합니다.
     */
    function createEventCard(event) {
        const card = document.createElement('div');
        card.className = 'event-card';

        // 날짜 형식 단순화 (문제 해결 핵심)
        const date = event.eventDate;

        const detailUrl = `/detail?id=${event.id}`;

        // Status 텍스트를 소문자로 변환하여 CSS 클래스에 사용
        const statusClass = event.status ? event.status.toLowerCase() : 'unknown';

        card.innerHTML = `
            <a href="${detailUrl}">
                <img src="${event.imageUrl || 'placeholder.jpg'}" alt="${event.title} 이미지" loading="lazy">
                <div class="card-body">
                    <h3 title="${event.title}">${event.title || '제목 없음'}</h3>
                    <p>종목: ${event.eventCategory || '미정'}</p>
                    <p>일시: ${date || '날짜 미정'}</p>
                    <span class="status status-${statusClass}">${event.status || '상태 미정'}</span>
                </div>
            </a>
        `;
        return card;
    }
</script>
</body>
</html>